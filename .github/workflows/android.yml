name: üì¶ Build Android APK and Push APK Branch

on:
  push:
    branches:
      - main

permissions:
  contents: write   # potrzebne, by workflow mog≈Ço pushowaƒá do repo

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /usr/lib/jvm/java-11-openjdk-amd64

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # potrzebne, by m√≥c pushowaƒá z powrotem

      - name: Set up Java 11
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip python3-venv \
            openjdk-11-jdk unzip zlib1g-dev libncurses5 libffi-dev \
            libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
            gstreamer1.0-plugins-base gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly \
            gstreamer1.0-libav build-essential git-core

      - name: Install Buildozer
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          pip3 install buildozer

      - name: Build APK with Buildozer
        run: |
          buildozer android debug --verbose

      - name: Debug: list contents of bin/
        run: |
          echo ">>> Zawarto≈õƒá katalogu bin:"
          if [ -d "bin" ]; then ls -R bin; else echo "(folder bin/ nie istnieje)"; fi

      - name: Commit and push APK to branch 'apk'
        env:
          REPO_URL: https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        run: |
          # znajd≈∫ apkƒô
          APK=$(ls bin/*.apk | head -n1)
          echo "Found APK: $APK"
          # klonuj repo z pe≈ÇnƒÖ historiƒÖ
          git clone "$REPO_URL" repo
          cd repo
          # utw√≥rz/ustaw branch apk
          git checkout --orphan apk
          # usu≈Ñ wszystkie stare pliki (je≈õli by≈Çy)
          git rm -rf .
          # skopiuj apkƒô do katalogu repo
          cp "../$APK" .
          # dodaj i skomituj
          git add *.apk
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "Add built APK from $GITHUB_SHA"
          # wymu≈õ wypchniƒôcie do branch apk
          git push -f origin apk
