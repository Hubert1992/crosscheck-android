name: ðŸ“¦ Build Android APK via Buildozer Container

on:
  push:
    branches:
      - main

permissions:
  contents: write
  actions: write

jobs:
  build:
    # zatkajemy nasz proces w kontenerze kivy/buildozer
    runs-on: ubuntu-latest
    container:
      image: kivy/buildozer:latest
      # root jest potrzebny, aby buildozer mÃ³gÅ‚ zapisaÄ‡ pliki w /home
      options: --user root

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Copy sources into container home
        run: |
          # buildozer container domyÅ›lnie pracuje w /home/user
          mkdir -p /home/user/app
          cp -R . /home/user/app
          cd /home/user/app

      - name: Ensure buildozer.spec exists
        run: |
          if [ ! -f /home/user/app/buildozer.spec ]; then
            echo "[app]" > buildozer.spec
            echo "title = Cross check" >> buildozer.spec
            echo "package.name = crosscheck" >> buildozer.spec
            echo "package.domain = org.example" >> buildozer.spec
            echo "source.dir = ." >> buildozer.spec
            echo "source.include_exts = py,kv,json" >> buildozer.spec
            echo "version = 1.0" >> buildozer.spec
            echo "requirements = python3,kivy" >> buildozer.spec
            echo "orientation = portrait" >> buildozer.spec
            echo "android.permissions = INTERNET" >> buildozer.spec
          fi

      - name: Install Cython (if needed)
        run: |
          cd /home/user/app
          pip install cython

      - name: Build APK
        run: |
          cd /home/user/app
          buildozer android debug --verbose

      - name: List built APK
        run: |
          cd /home/user/app/bin
          echo ">>> ZawartoÅ›Ä‡ bin/:"
          ls -l

      - name: Push APK to branch 'apk'
        env:
          REPO: https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        run: |
          cd /home/user/app
          APK=$(ls bin/*.apk | head -n1)
          git clone "$REPO" out
          cd out
          git checkout --orphan apk
          git rm -rf .
          cp "../$APK" .
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add *.apk
          git commit -m "Add APK from $GITHUB_SHA"
          git push -f origin apk
