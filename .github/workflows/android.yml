name: üì¶ Build Android APK and Publish

# Wymagane uprawnienia, ≈ºeby workflow m√≥g≈Ç dopa≈õƒá kod i go pushowaƒá
permissions:
  contents: write
  actions: write

on:
  push:
    branches:
      - main

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /usr/lib/jvm/java-11-openjdk-amd64

    steps:
      # 1) Pobierz kod repo (z pe≈ÇnƒÖ historiƒÖ, bo potem force‚Äëpushujemy)
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2) Java 11
      - name: Set up Java 11
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '11'

      # 3) Systemowe zale≈ºno≈õci pod Buildozer
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip python3-venv \
            openjdk-11-jdk unzip zlib1g-dev libncurses5 libffi-dev \
            libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
            gstreamer1.0-plugins-base gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly gstreamer1.0-libav \
            build-essential git-core

      # 4) Buildozer
      - name: Install Buildozer
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          pip3 install buildozer

      # 5) Budowa APK
      - name: Build APK with Buildozer
        run: buildozer android debug --verbose

      # 6) Debug: co jest w bin/ ?
      - name: List contents of bin/
        run: |
          echo ">>> Zawarto≈õƒá katalogu bin:"
          if [ -d bin ]; then ls -R bin; else echo "(bin/ nie istnieje)"; fi

      # 7) Wypchniƒôcie APK do brancha apk
      - name: Push APK to branch
        env:
          REPO: https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        run: |
          APK_FILE=$(ls bin/*.apk 2>/dev/null | head -n1)
          if [ -z "$APK_FILE" ]; then
            echo "Nie znaleziono .apk w bin/, zako≈Ñczone bez push."
            exit 1
          fi
          echo "Znaleziono APK: $APK_FILE"
          git clone "$REPO" out
          cd out
          git checkout --orphan apk
          git rm -rf .
          cp "../$APK_FILE" .
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add *.apk
          git commit -m "Add APK from $GITHUB_SHA"
          git push -f origin apk
